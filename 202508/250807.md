# 📆 2025-08-07 (목)
## 🥅 오늘 목표 
- [x] 운영툴 패키지 작업 
- [ ] 로그 관련 기술 블로그 글 쓰기 
- [ ] 랠릿 정리 
- [x] 연관 상품 리팩토링
- [x] 스터디 계획 

## ☑️ 오늘 한 일 📑 ( 목표하지 않았지만 추가된 것들 )
- [x] 기업 관련 추가 요구사항 미팅
- [x] 상품 조회 쿼리 튜닝


***

## 🔍️ 오늘 무엇을 했나요? Review
### [WORK] 연관 상품 리팩토링
상품과 매핑하는 key 값을 pk로 전환하는 작업을 진행했다. (원래는 레거시와 신규 둘 다 지원하기 위해 pk가 아닌 다른 값을 이용했음) 큰거를 건드렸기 때문에 테스트가 와장창 깨졌는데, 그동안 경험했던 (나 또한) 개발자들은 테스트가 깨지면 코드를 고치는게 아니라 테스트를 통과하도록 테스트를 고친다. 이것이 TDD인 척 하는 그냥 보여주기식 TDD의 폐해인데. 나 또한 무의식적으로 그러려고 했다. 근데 문득, 아니지 테스트가 실패했다면 내가 전환하는 과정에서 뭔가를 잘못했으리라. 다시 코드를 살펴보았다. 이런, 큰일날 뻔했다. 매핑 키를 잘못 매핑하고 있었다. 휴.. 

### [WORK] 기업 관련 추가 요구사항 미팅 
B2B 서비스 관련 추가 요구사항이 들어왔다. 테스크 담당은 내가 아닌 다른 분. 추가 요구사항에 대해 나와 논의를 하라하였다. 급한 업무들을 마구 처리하고 있는데, 자리로 찾아오셨다. 이번주내내 마치 교통사고 당하듯 컨텍스트 스위칭이 예기치 않게 일어났기 때문에 "잠시만요"하고 그분을 멈추었다. 하던 일을 급하게 마무리 짓고 그분에게 어떤 용무인지 물었다. 곧바로 앞 뒤 맥락을 생략한 기술 구현에 대한 이야기를 와다다다다 쏟아내셨다. 그분을 멈춰세웠다. "잠시만요. 이따가 회의 잡고 이야기할까요? 1시 30분 괜찮으신가요?" 미팅을 잡았다. 불필요한 끼어듬을 방지하기 위함도 있었다. 

회의에 들어가니 또 다시 와다다다다다다다 기술 구현을 냅다 쏟아내셨다. 

이렇게 이렇게하면 되지 않을까요? 

음... 맥락없이 그렇게 이야기하면 업무에 대한 정보가 없는 사람은 무슨 소리인지 알 수 없을 거에요. 자 이제 회의를 시작해볼까요?
우리는 무슨 문제를 해결해야하죠? 고객은 어떤 문제를 제기했나요? 

문제 정의부터 먼저했다. 항상 업무가 문제 + 업무를 주는 사람이 생각한 해결법이 같이 왔다. 그러다보니 해결법에 집중되어 시야가 좁아져 저멀리 산으로 가는 경우가 많았다. 
그 다음은 해결해야 하는 도메인에 대한 정보 수집. 도메인에 대해 정확한 정보없이 그저 추측으로만 설계하면 계속해서 수정하다가 결국 엄청 복잡해진다. 
도메인 구조가 있을 때, 연관 관계가 있는 두 도메인의 중간에 다른 도메인을 끼워 넣는거 보다 두 도메인의 바깥에서 연결하는 것이 데이터 보정에도 로직 수정에도 용이하다. 

회의하는 동안 화이트보드를 사용해서 현재 우리 구조는 무엇이고, 어떻게 변경해야 문제를 해결할 수 있는지, 어떤 방법들이 있고 각 방법들의 장단점은 무엇인지 생각해보라고 제안했다. 
요즘 챗GPT, cursor, cluade 등 많은 AI로 편리하게 코딩을 하다보니 왜 이렇게 짰어요?에 대한 질문에 대답을 잘 못하는 경우가 많다. 
이러면 성장하지 못한다. 또, 안전하지 않다. 검증하지 않았으니. 그래서 계속 의식적으로 고민하는 법을 알려주고 싶었다. 

### [WORK] 쿼리 튜닝 

메인 페이지에서 사용하는 쿼리가 DB 로드 TOP1을 찍었다. 필터기능이 많이 들어가면서 여러 테이블을 조인하고 집계하기 때문에 코스트가 높았다. 
트래픽과는 무관하게 CPU가 100에 가까이 찍히며 메인 페이지가 안뜨기도 했다 (자주는 아니지만 언제 또 발생할지 모르는 상태)

쿼리 문제였다면 동일한 트래픽에서 계속해서 같은 현상이 일어났어야했는데 그렇지 않았다. 다른 요인이 있을거라고 의심. 

일단, 그래도 쿼리의 성능을 개선하면 더 좋기 때문에 `EXPLANE ANALYZE`를 사용하여 비용이랑 어느정도 걸리는지 각 구간은 어떤지 분석했다. 
코드를 수정하지 않고 DB만 제어하여 성능을 개선해야 했기 때문에 DB설정과 인덱스를 건드렸다. 
`work_mem`이 기본 4MB여서 128MB로 올린뒤 다시 분석 딱히 성능 개선이 되지 않았다. (64MB로 수정해야지)
( `work_mem`은 정렬 / 해시 / 조인 작업이 한 쿼리에서 동시에 일어날 수 있기 때문에, 각각의 동작에서 사용할 수 있는 메모리 수치를 의미. 너무 커도 안좋음.)

다음은 서브쿼리에 사용되는 테이블에 인덱스를 추가했다. 36% 성능 개선! 다음은 집계 쿼리에 인덱스 추가. 

결론적으로 인덱스 4개 추가해서 성능이 반(?) 좋아졌다. 

확연히, 메인페이지가 빨라졌다. 후.. 추후 계속 모니터링하면서 개선을.. 

***

## 💡 오늘 회고
오전부터 정말 진짜 까닥하면 바로 잠들어버릴 정도로 체력이 바닥이어서 간신히 간신히 업무를 이어나갔다. 
그래도 리팩터링도 어느정도 마무리하고 그 리팩터링 하면서 만든 버그도 정리하고 계속 미뤄졌던 패키지 작업도 조금 더 진행했다. 
쿼리 성능도 개선하고.. 뭔가 기능 논의 미팅 때 괜히 그냥 넘어갈 수 있는 거를 마치 학생 가르치듯 한거 같아서 찜찜했다. 담엔 그러지 말아야지. 
회고를 이미 위에 많이 섞어서 딱히 또 할 말이 떠오르지 않는다. 역대급 힘들었던 오늘도 잘해냈다. 내일도 화이팅.... 
언제 쉬지 ㅠ 

## 🎯 내일 할 일
- [ ] 

***

## 🏁 이번주 목표 🏁
- [ ] 패키지 작업 
- [ ] 랠릿, 깃블로그 이력서 등 내가 한 일에 대한 업데이트 
- [ ] 강의, 책, 사이드 프로젝트 등 무언가 꾸준히 실행하기 
